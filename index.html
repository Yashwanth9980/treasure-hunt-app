<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Treasure Hunt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .card-glow { box-shadow: 0 0 15px rgba(74, 222, 128, 0.3), 0 0 5px rgba(74, 222, 128, 0.2); }
        .btn-glow:hover { box-shadow: 0 0 20px rgba(59, 130, 246, 0.7); }
        #qrcode-container img { margin: auto; background: white; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-orbitron font-bold text-green-400">Neural Quest</h1>
            <p id="header-subtitle" class="text-gray-400 mt-2">Create or solve your next clue.</p>
        </header>

        <main id="participant-page" class="bg-gray-800 border border-gray-700 rounded-lg p-6 md:p-8 card-glow hidden">
            <div id="team-entry-view">
                <h3 class="text-xl font-bold text-center mb-4">Welcome, Treasure Hunter!</h3>
                <div class="space-y-4">
                    <div>
                        <label for="team-name-input" class="block mb-2 text-sm font-medium text-gray-300">Enter Your Team Name</label>
                        <input type="text" id="team-name-input" class="w-full bg-gray-900 border border-gray-600 rounded-md px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., The Code Breakers">
                    </div>
                    <button id="start-puzzle-button" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-md hover:bg-green-700 transition-all duration-300 btn-glow">Start Puzzle</button>
                </div>
            </div>

            <div id="puzzle-view" class="hidden">
                 <div id="info-section" class="mb-6 p-4 bg-gray-900 rounded-md">
                     <h2 class="text-lg font-bold">Team: <span id="team-id-display" class="text-green-400"></span></h2>
                 </div>
                <div id="puzzle-container" class="mb-6">
                    <p id="puzzle-text" class="text-lg md:text-xl leading-relaxed text-gray-200 min-h-[100px]"></p>
                    <div id="puzzle-loading-spinner" class="hidden flex items-center justify-center min-h-[100px]">
                        <svg class="animate-spin h-8 w-8 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span class="ml-4 text-gray-400">Loading your puzzle...</span>
                    </div>
                </div>
                <div id="answer-section">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="answer-input" placeholder="What location is this?" class="flex-grow bg-gray-900 border border-gray-600 rounded-md px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                        <button id="submit-button" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition-all duration-300 btn-glow">Submit Answer</button>
                    </div>
                </div>
                <div id="message-area" class="mt-4 text-center font-semibold h-6"></div>
                <div id="correct-answer-view" class="hidden mt-6 text-center space-y-4">
                    <h3 class="text-2xl font-bold text-green-400">Correct! âœ…</h3>
                    <p class="text-lg">
                        Complete the task given by the volunteer.
                        <br>
                        Then, head to your next location: <strong id="next-location-display" class="text-yellow-400"></strong>
                    </p>
                </div>
            </div>
        </main>

        <main id="volunteer-page" class="bg-gray-800 border border-gray-700 rounded-lg p-6 md:p-8 card-glow hidden">
            <h2 class="text-2xl font-bold text-center mb-6 text-blue-400">Volunteer QR Code Generator</h2>
            <div class="space-y-4">
                 <div id="location-input-wrapper">
                    <label for="next-location-input" class="block mb-2 text-sm font-medium text-gray-300">Enter Secret Next Location</label>
                    <input type="text" id="next-location-input" class="w-full bg-gray-900 border border-gray-600 rounded-md px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., The Old Clock Tower">
                </div>
                <button id="generate-qr-button" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition-all duration-300 btn-glow">Generate Clue & QR Code</button>
            </div>
            <div id="qrcode-container" class="mt-6 text-center"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Element References
        const participantPage = document.getElementById('participant-page');
        const volunteerPage = document.getElementById('volunteer-page');
        const headerSubtitle = document.getElementById('header-subtitle');
        const teamEntryView = document.getElementById('team-entry-view');
        const puzzleView = document.getElementById('puzzle-view');
        const teamNameInput = document.getElementById('team-name-input');
        const startPuzzleButton = document.getElementById('start-puzzle-button');
        const teamIdDisplay = document.getElementById('team-id-display');
        const puzzleTextEl = document.getElementById('puzzle-text');
        const answerInput = document.getElementById('answer-input');
        const submitButton = document.getElementById('submit-button');
        const messageArea = document.getElementById('message-area');
        const puzzleLoadingSpinner = document.getElementById('puzzle-loading-spinner');
        const correctAnswerView = document.getElementById('correct-answer-view');
        const nextLocationDisplay = document.getElementById('next-location-display');
        const locationInputWrapper = document.getElementById('location-input-wrapper');
        const nextLocationInput = document.getElementById('next-location-input');
        const generateQrButton = document.getElementById('generate-qr-button');
        const qrcodeContainer = document.getElementById('qrcode-container');

        // Firebase & API Key Initialization
        let db, auth;
        const firebaseConfig = {
            apiKey: "AIzaSyAnT2kN6DEXBX_di6KqBsdhxLByWQ3eJE0",
            authDomain: "neural-quest-51f1b.firebaseapp.com",
            projectId: "neural-quest-51f1b",
            storageBucket: "neural-quest-51f1b.appspot.com",
            messagingSenderId: "149762631280",
            appId: "1:149762631280:web:7b8e53a9711f0fc90536b5",
            measurementId: "G-V1VX8NDWRC"

        };

        // PASTE YOUR GEMINI API KEY HERE
        const GEMINI_API_KEY = "AIzaSyAUqoWFlYuI4on9XkXed58bXVnlSYZoP68";

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        routeApplication();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.body.innerHTML = `<div class="text-red-500 text-center p-8">Error: Failed to initialize. Check your Firebase config.</div>`;
            }
        }

        function routeApplication() {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.has('clueId') ? showParticipantPage() : showVolunteerPage();
        }

        // --- PAGE ROUTING ---
        function showVolunteerPage() {
            headerSubtitle.textContent = "Create the next secret clue.";
            participantPage.classList.add('hidden');
            volunteerPage.classList.remove('hidden');
            initializeVolunteerLogic();
        }

        function showParticipantPage() {
            headerSubtitle.textContent = "Your next clue awaits. Think fast, move faster.";
            volunteerPage.classList.add('hidden');
            participantPage.classList.remove('hidden');
            initializeParticipantLogic();
        }

        // --- VOLUNTEER LOGIC ---
        function initializeVolunteerLogic() {
            // I've restored the random puzzle logic from our previous session
            generateQrButton.onclick = async () => {
                const nextLocation = nextLocationInput.value.trim();
                if (!nextLocation) {
                    alert("Please enter the next location.");
                    return;
                }
                
                generateQrButton.disabled = true;
                generateQrButton.textContent = "Generating AI Puzzle...";
                qrcodeContainer.innerHTML = '';

                try {
                    const puzzleStyles = [
                        "a cryptic, rhyming couplet",
                        "a multi-step logic problem",
                        "an abstract, metaphorical riddle",
                        "a clue based on historical or local trivia",
                        "a pun-filled, humorous question",
                        "a puzzle that requires lateral thinking",
                        "a short, enigmatic poem"
                    ];
                    const randomStyle = puzzleStyles[Math.floor(Math.random() * puzzleStyles.length)];

                    const prompt = `You are a master of cryptic puzzles for a treasure hunt. Your task is to generate a single, difficult puzzle in the style of ${randomStyle}. The puzzle's secret answer, which you must NOT reveal, is: "${nextLocation}". Your response must ONLY be the puzzle text itself. Do not add explanations or the answer. The puzzle must hint at "${nextLocation}" in a challenging, indirect way. Make this puzzle unique and different from any you've created before.`;
                    
                    const puzzle = await generateWithGemini(prompt);
                    
                    generateQrButton.textContent = "Saving Clue...";
                    const clueDocRef = await addDoc(collection(db, "clues"), {
                        puzzle: puzzle,
                        answer: nextLocation.toLowerCase()
                    });
                    
                    const clueId = clueDocRef.id;
                    const baseUrl = window.location.href.split('?')[0];
                    const playerUrl = `${baseUrl}?clueId=${clueId}`;

                    new QRCode(qrcodeContainer, { text: playerUrl, width: 256, height: 256 });
                    
                    locationInputWrapper.classList.add('hidden');

                } catch (error) {
                    console.error("Error creating clue:", error);
                    alert("Could not generate QR code. Check API Key and database connection.");
                } finally {
                    generateQrButton.disabled = false;
                    generateQrButton.textContent = "Generate Clue & QR Code";
                }
            };
        }

        // --- PARTICIPANT LOGIC ---
        function initializeParticipantLogic() {
            const urlParams = new URLSearchParams(window.location.search);
            const clueId = urlParams.get('clueId');
            
            startPuzzleButton.onclick = async () => {
                const teamName = teamNameInput.value.trim();
                if (!teamName) {
                    alert("Please enter a team name to begin!");
                    return;
                }
                
                teamEntryView.classList.add('hidden');
                puzzleView.classList.remove('hidden');
                teamIdDisplay.textContent = teamName;
                puzzleLoadingSpinner.classList.remove('hidden');

                try {
                    const clueDocRef = doc(db, "clues", clueId);
                    const clueDocSnap = await getDoc(clueDocRef);

                    if (!clueDocSnap.exists()) {
                        participantPage.innerHTML = `<p class="text-red-400 text-center">Error: Invalid clue ID. Please re-scan the QR code.</p>`;
                        return;
                    }
                    const clueData = clueDocSnap.data();
                    
                    puzzleLoadingSpinner.classList.add('hidden');
                    puzzleTextEl.textContent = clueData.puzzle;
                    
                    submitButton.onclick = async () => {
                        const userAnswer = answerInput.value.trim().toLowerCase();
                        if (userAnswer === clueData.answer) {
                            messageArea.textContent = 'Correct! Well done!';
                            messageArea.className = 'mt-4 text-center font-semibold h-6 text-green-400';
                            document.getElementById('answer-section').style.display = 'none';
                            correctAnswerView.classList.remove('hidden');
                            nextLocationDisplay.textContent = clueData.answer.charAt(0).toUpperCase() + clueData.answer.slice(1);
                            
                            const progressDocRef = doc(db, "progress", `${teamName}_${clueId}`);
                            await setDoc(progressDocRef, { solved: true, solvedTimestamp: new Date() });
                            
                        } else {
                            messageArea.textContent = 'Not quite. Try another answer!';
                            messageArea.className = 'mt-4 text-center font-semibold h-6 text-red-400';
                            answerInput.select();
                        }
                    };
                } catch (error) {
                    console.error("Error fetching clue:", error);
                    participantPage.innerHTML = `<p class="text-red-400 text-center">Error: Could not load the puzzle. Please check your connection and refresh.</p>`;
                }
            };
        }
        
        async function generateWithGemini(prompt) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === "AIzaSyB3cKpPz8RUvhdtFGzBFW2SVvfstS4Pae0") {
                console.error("Gemini API Key is missing.");
                throw new Error("AI generator is not configured.");
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                 const errorBody = await response.text();
                 console.error("Gemini API Error Response:", errorBody);
                 throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            }
            throw new Error("Invalid AI response format from Gemini API");
        }

        initializeFirebase();

    </script>
</body>
</html>